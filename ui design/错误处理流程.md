# 错误处理流程

> ⚠️ **重要：** 此文档仅在处理错误时使用。正常开发请参考 `ui设计稿生成规范.md`

## 🚨 错误处理工作流程

### 第一步：错误识别

#### 1.1 错误来源
- **用户反馈：** 用户报告插件运行错误
- **控制台错误：** 开发时控制台显示错误信息
- **测试发现：** 功能测试时发现异常行为

#### 1.2 错误信息收集
- [ ] 记录完整错误信息（复制错误文本）
- [ ] 记录错误发生时的操作步骤
- [ ] 截图错误界面（如有）
- [ ] 查看控制台详细错误（点击 "Show/Hide console"）

### 第二步：错误分类

根据错误信息，将错误分类到以下类别：

#### 类别 1：模块系统错误
**错误特征：**
- `require is not defined`
- `import is not defined`
- `Cannot find module`

**解决方案：** 参考下方"错误 1"的详细处理

#### 类别 2：颜色格式错误
**错误特征：**
- `Unrecognized key(s) in object: 'a'`
- `Property "fills" failed validation`
- 与 `color` 或 `fills` 相关的验证错误

**解决方案：** 参考下方"错误 2"、"错误 3"和"错误 5"的详细处理

#### 类别 3：字体加载错误
**错误特征：**
- `Cannot write to node with unloaded font`
- `Please call figma.loadFontAsync`
- 与 `fontName` 或 `characters` 相关的错误

**解决方案：** 参考下方"错误 4"的详细处理

#### 类别 4：其他错误
**错误特征：** 不属于以上类别的错误

**解决方案：** 参考下方"通用错误处理"

---

## 🔧 常见错误详细处理

### 错误 1：`require is not defined` 或 `import is not defined`

#### 错误信息示例
```
创建失败: 'require' is not defined
```

#### 原因分析
- Figma 插件环境不支持 Node.js 的 `require` 或 ES6 的 `import`
- 插件运行在浏览器环境中，不支持模块系统

#### 解决步骤

1. **定位问题代码**
   ```javascript
   // 找到使用 require 或 import 的代码
   const { colors } = require('./design-tokens.js');
   // 或
   import { colors } from './design-tokens.js';
   ```

2. **内联代码**
   ```javascript
   // 将依赖的代码直接复制到当前文件
   const colors = {
     primary: { r: 0.31, g: 0.27, b: 0.90 },
     // ... 其他颜色定义
   };
   ```

3. **验证修复**
   - [ ] 删除所有 `require` 和 `import` 语句
   - [ ] 确保所有依赖已内联
   - [ ] 重新加载插件测试

#### 预防措施
- ✅ 所有代码必须内联到 `code.js`
- ✅ 不使用任何模块系统
- ✅ 设计令牌直接定义在代码中

---

### 错误 2：`Unrecognized key(s) in object: 'a'` (SOLID 类型)

#### 错误信息示例
```
Property "fills" failed validation: Unrecognized key(s) in object: 'a' at [0].color
```

#### 原因分析
- Figma API 的 `SOLID` 类型填充不接受 `a` (alpha) 属性
- 颜色对象只能包含 `r`, `g`, `b` 三个属性

#### 解决步骤

1. **定位问题代码**
   ```javascript
   // 找到使用 SOLID 类型的地方
   rect.fills = [{ 
     type: 'SOLID', 
     color: { r: 0.31, g: 0.27, b: 0.90, a: 1 }  // ❌ 包含 a
   }];
   ```

2. **移除 a 属性**
   ```javascript
   // 修复后
   rect.fills = [{ 
     type: 'SOLID', 
     color: { r: 0.31, g: 0.27, b: 0.90 }  // ✅ 不包含 a
   }];
   ```

3. **检查颜色转换函数**
   ```javascript
   // 确保 hexToRgb 不返回 a
   function hexToRgb(hex) {
     return {
       r: parseInt(result[1], 16) / 255,
       g: parseInt(result[2], 16) / 255,
       b: parseInt(result[3], 16) / 255
       // 不包含 a
     };
   }
   ```

4. **验证修复**
   - [ ] 所有 SOLID 类型颜色不包含 `a`
   - [ ] `hexToRgb` 函数不返回 `a`
   - [ ] 重新测试功能

#### 预防措施
- ✅ `hexToRgb` 函数只返回 `{ r, g, b }`
- ✅ SOLID 类型颜色不包含 `a` 属性
- ✅ 代码审查时检查颜色格式

---

### 错误 3：渐变缺少 `gradientTransform` 或 `color.a`

#### 错误信息示例
```
Property "fills" failed validation: 
- Expected [0].gradientTransform to be one of the following
- Required value missing at [0].gradientStops[0].color.a
- Required value missing at [0].gradientStops[1].color.a
```

#### 原因分析
- `GRADIENT_LINEAR` 类型**必须**包含 `gradientTransform`
- `gradientStops` 中的颜色对象**必须**包含 `a` 属性

#### 解决步骤

1. **定位问题代码**
   ```javascript
   // 找到使用渐变的地方
   frame.fills = [{
     type: 'GRADIENT_LINEAR',
     gradientStops: [
       { position: 0, color: { r: 0.31, g: 0.27, b: 0.90 } },  // ❌ 缺少 a
       { position: 1, color: { r: 0.58, g: 0.20, b: 0.92 } },  // ❌ 缺少 a
     ],
     // ❌ 缺少 gradientTransform
   }];
   ```

2. **添加 gradientTransform 和 a 属性**
   ```javascript
   // 修复后
   const gradientFrom = {
     r: 0.31, g: 0.27, b: 0.90, a: 1  // ✅ 包含 a
   };
   const gradientTo = {
     r: 0.58, g: 0.20, b: 0.92, a: 1  // ✅ 包含 a
   };
   
   frame.fills = [{
     type: 'GRADIENT_LINEAR',
     gradientTransform: [[1, 0, 0], [0, 1, 0]],  // ✅ 包含
     gradientStops: [
       { position: 0, color: gradientFrom },
       { position: 1, color: gradientTo },
     ],
   }];
   ```

3. **验证修复**
   - [ ] 所有渐变包含 `gradientTransform`
   - [ ] 所有渐变颜色包含 `a: 1`
   - [ ] 重新测试功能

#### 预防措施
- ✅ 创建渐变时同时添加 `gradientTransform`
- ✅ 渐变颜色对象明确包含 `a: 1`
- ✅ 使用辅助函数创建渐变颜色对象

---

### 错误 4：`Cannot write to node with unloaded font`

#### 错误信息示例
```
Cannot write to node with unloaded font "Inter Regular". 
Please call figma.loadFontAsync({ family: "Inter", style: "Regular" }) 
and await the returned promise first.
```

#### 原因分析
- 在设置 `characters` 之前，必须先设置 `fontName`
- 必须先 `await` 字体加载完成

#### 解决步骤

1. **定位问题代码**
   ```javascript
   // 找到创建文本的代码
   const textNode = figma.createText();
   textNode.characters = '文本';  // ❌ 先设置 characters
   textNode.fontName = { family: 'Inter', style: 'Regular' };
   ```

2. **调整顺序并加载字体**
   ```javascript
   // 修复后
   // 步骤 1: 加载字体
   await figma.loadFontAsync({ family: 'Inter', style: 'Regular' });
   
   // 步骤 2: 创建节点
   const textNode = figma.createText();
   
   // 步骤 3: 先设置 fontName
   textNode.fontName = { family: 'Inter', style: 'Regular' };
   
   // 步骤 4: 设置 fontSize
   textNode.fontSize = 16;
   
   // 步骤 5: 最后设置 characters
   textNode.characters = '文本';
   ```

3. **批量文本优化**
   ```javascript
   // 如果创建大量文本，预加载字体
   await Promise.all([
     figma.loadFontAsync({ family: 'Inter', style: 'Regular' }),
     figma.loadFontAsync({ family: 'Inter', style: 'Medium' }),
   ]);
   ```

4. **验证修复**
   - [ ] 所有文本创建前都加载字体
   - [ ] `fontName` 在 `characters` 之前设置
   - [ ] 使用 `await` 等待字体加载
   - [ ] 重新测试功能

#### 预防措施
- ✅ 创建文本的标准流程：加载字体 → 创建节点 → 设置 fontName → 设置 fontSize → 设置 characters
- ✅ 大量文本前预加载所有需要的字体
- ✅ 使用统一的 `createTextNode` 函数

---

### 错误 5：SOLID 类型颜色包含 `a` 属性（透明度）

#### 错误信息示例
```
创建失败: in set_fills: Property "fills" failed validation: 
Unrecognized key(s) in object: 'a' at [0].color
```

#### 原因分析
- Figma API 的 `SOLID` 类型填充的颜色对象**不接受** `a` (alpha/透明度) 属性
- 即使设置了 `a` 属性，也会被拒绝（与渐变不同）
- 如需透明效果，必须使用元素的 `opacity` 属性

#### 解决步骤

1. **定位问题代码**
   ```javascript
   // 找到使用 SOLID 类型且包含 a 属性的地方
   element.fills = [{ 
     type: 'SOLID', 
     color: { r: 1, g: 1, b: 1, a: 0.2 }  // ❌ 包含 a
   }];
   ```

2. **方法 1：使用 opacity 属性**
   ```javascript
   // 修复后：使用 opacity 属性
   element.fills = [{ 
     type: 'SOLID', 
     color: { r: 1, g: 1, b: 1 }  // ✅ 不包含 a
   }];
   element.opacity = 0.2;  // ✅ 使用 opacity 设置透明度
   ```

3. **方法 2：使用不透明颜色**
   ```javascript
   // 修复后：使用视觉上接近的不透明颜色
   element.fills = [{ 
     type: 'SOLID', 
     color: grayColors[200]  // ✅ 使用浅灰色代替白色透明
   }];
   ```

4. **验证修复**
   - [ ] 移除所有 SOLID 颜色对象中的 `a` 属性
   - [ ] 如需透明效果，使用 `element.opacity`
   - [ ] 重新测试功能

#### 对比：SOLID vs 渐变

| 类型 | 颜色格式 | 透明度 |
|------|---------|--------|
| SOLID | `{ r, g, b }` 不含 `a` | 使用 `element.opacity` |
| GRADIENT | `{ r, g, b, a: 1 }` 必须含 `a` | `a` 属性在 gradientStops 中 |

#### 预防措施
- ✅ SOLID 类型颜色对象**永远不包含** `a` 属性
- ✅ 需要透明效果时使用 `element.opacity` 属性
- ✅ 或选择视觉上接近的不透明颜色
- ✅ 渐变类型的颜色**必须包含** `a` 属性

---

## 🔍 通用错误处理

### 步骤 1：收集错误信息
```javascript
// 在 catch 块中记录详细信息
catch (error) {
  const errorInfo = {
    message: error.message,
    stack: error.stack,
    timestamp: new Date().toISOString(),
    userAction: '创建设计系统示例',  // 记录用户操作
  };
  
  console.error('错误详情:', errorInfo);
  figma.notify(`创建失败: ${error.message}`);
}
```

### 步骤 2：分析错误
- 查看错误堆栈，定位问题代码行
- 检查错误类型，判断属于哪个类别
- 查看相关代码，理解错误原因

### 步骤 3：查找解决方案
- 首先查看本文档中的常见错误
- 检查 `ui设计稿生成规范.md` 中的规范
- 参考 Figma Plugin API 文档

### 步骤 4：实施修复
- 按照解决方案修复代码
- 确保遵循所有必须遵守的规范
- 添加必要的错误处理

### 步骤 5：测试验证
- [ ] 修复后重新测试功能
- [ ] 验证错误已解决
- [ ] 确认未引入新错误
- [ ] 测试相关功能是否正常

### 步骤 6：文档更新
- [ ] 如果是新错误，添加到本文档
- [ ] 更新解决方案（如发现更好的方法）
- [ ] 更新预防措施

---

## 📋 错误处理检查清单

### 错误识别阶段
- [ ] 记录完整错误信息
- [ ] 记录操作步骤
- [ ] 查看控制台详细错误
- [ ] 截图错误界面（如有）

### 错误分类阶段
- [ ] 确定错误类别
- [ ] 找到对应的解决方案
- [ ] 定位问题代码位置

### 错误修复阶段
- [ ] 按照解决方案修复
- [ ] 遵循必须遵守的规范
- [ ] 添加错误处理代码

### 测试验证阶段
- [ ] 重新测试功能
- [ ] 验证错误已解决
- [ ] 确认未引入新错误

### 文档更新阶段
- [ ] 更新错误处理文档（如需要）
- [ ] 更新设计规范（如需要）

---

## 🎯 快速错误定位

### 根据错误关键词快速定位

| 错误关键词 | 错误类别 | 参考解决方案 |
|-----------|---------|------------|
| `require is not defined` | 模块系统 | 错误 1 |
| `import is not defined` | 模块系统 | 错误 1 |
| `Unrecognized key(s) in object: 'a'` | 颜色格式 | 错误 2 |
| `gradientTransform` | 渐变格式 | 错误 3 |
| `color.a` | 渐变格式 | 错误 3 |
| `unloaded font` | 字体加载 | 错误 4 |
| `loadFontAsync` | 字体加载 | 错误 4 |
| `Unrecognized key(s) in object: 'a'` (SOLID) | 颜色透明度 | 错误 5 |
| `a` in SOLID color | 颜色透明度 | 错误 5 |

---

## 📚 相关资源

- **Figma Plugin API 文档：** https://www.figma.com/plugin-docs/
- **设计规范：** `ui设计稿生成规范.md`
- **快速参考：** `QUICK_REFERENCE.md`

---

**版本：** 1.0  
**最后更新：** 2024-12  
**适用插件：** 钢琴练习应用工具

